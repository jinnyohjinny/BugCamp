FROM alpine:3.4

# Install necessary packages and build tools
RUN apk add --no-cache \
    lighttpd \
    lighttpd-mod_auth \
    curl \
    wget \
    build-base \
    ncurses-dev

# Download and compile vulnerable bash 4.3.0 (definitely vulnerable to Shellshock)
RUN wget https://ftp.gnu.org/gnu/bash/bash-4.3.tar.gz && \
    tar -xzf bash-4.3.tar.gz && \
    cd bash-4.3 && \
    ./configure --prefix=/usr --without-bash-malloc && \
    make && \
    make install && \
    cd .. && \
    rm -rf bash-4.3 bash-4.3.tar.gz

# Remove build tools to keep image small
RUN apk del build-base

# Create necessary directories
RUN mkdir -p /var/www/localhost/htdocs \
    && mkdir -p /var/www/localhost/cgi-bin \
    && mkdir -p /var/log/lighttpd \
    && mkdir -p /run/lighttpd \
    && mkdir -p /var/cache/lighttpd/uploads \
    && mkdir -p /var/cache/lighttpd/compress

# Copy web content
COPY www/ /var/www/localhost/htdocs/
COPY cgi-bin/ /var/www/localhost/cgi-bin/
COPY lighttpd.conf /etc/lighttpd/lighttpd.conf

# Set proper permissions
RUN chmod +x /var/www/localhost/cgi-bin/* \
    && chown -R lighttpd:lighttpd /var/www/localhost \
    && chown -R lighttpd:lighttpd /var/log/lighttpd \
    && chown -R lighttpd:lighttpd /run/lighttpd \
    && chown -R lighttpd:lighttpd /var/cache/lighttpd

# Expose port 80
EXPOSE 80

# Start lighttpd
CMD ["lighttpd", "-D", "-f", "/etc/lighttpd/lighttpd.conf"]
